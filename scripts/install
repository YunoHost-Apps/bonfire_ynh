#!/bin/bash

source /usr/share/yunohost/helpers

#=================================================
# ENABLE POSTGRESQL EXTENSIONS
#=================================================
ynh_script_progression "Enabling PostgreSQL extensions..."

ynh_psql_db_shell <<< "CREATE EXTENSION IF NOT EXISTS citext WITH SCHEMA public;"

ynh_psql_db_shell <<< "CREATE EXTENSION IF NOT EXISTS postgis WITH SCHEMA public;"

#=================================================
# DOWNLOAD PRE-BUILT RELEASE
#=================================================
ynh_script_progression "Downloading Bonfire release (this may take a few minutes)..."

# Download and extract pre-built release
ynh_setup_source --dest_dir="$install_dir"

#=================================================
# SETUP DIRECTORIES
#=================================================
ynh_script_progression "Setting up directories..."

mkdir -p "$data_dir/uploads"
mkdir -p "/var/log/$app"

#=================================================
# GENERATE SECRETS
#=================================================
ynh_script_progression "Generating secrets..."

## Generate secrets and other config values
secret_key_base=$(ynh_string_random --length=64)
signing_salt=$(ynh_string_random --length=64)
encryption_salt=$(ynh_string_random --length=64)
# search
meili_master_key=$(ynh_string_random --length=64)
# max file upload size - convert from "35MB" to bytes "35000000"
upload_limit_bytes="${media_upload_size//[!0-9]/}000000"

# Set instance configuration from installation questions
# These variables are automatically available from manifest.toml [install] section:
# - $instance_name
# - $invite_only (true/false)
# - $instance_description (optional)

# Save app settings for upgrade/backup/restore
ynh_app_setting_set --key=secret_key_base --value=$secret_key_base
ynh_app_setting_set --key=signing_salt --value=$signing_salt
ynh_app_setting_set --key=encryption_salt --value=$encryption_salt
ynh_app_setting_set --key=meili_master_key --value=$meili_master_key
ynh_app_setting_set --key=instance_name --value=$instance_name
ynh_app_setting_set --key=invite_only --value=$invite_only
ynh_app_setting_set --key=instance_description --value="$instance_description"
ynh_app_setting_set --key=media_upload_size --value=$media_upload_size

#=================================================
# INSTALL MEILISEARCH
#=================================================
ynh_script_progression "Installing Meilisearch..."

# Download and install Meilisearch
meili_version="v1.28.1"
ynh_setup_source --dest_dir="$install_dir" --source_id="meili"
chmod +x "$install_dir/meilisearch"

# Create meilisearch data directory
mkdir -p "$data_dir/meilisearch"
mkdir -p "$data_dir/meilisearch/dumps"
echo $meili_version > "$data_dir/meilisearch/VERSION"
chown -R $app:$app "$data_dir/meilisearch"
chmod 750 "$data_dir/meilisearch"

# Create log directory for both services
mkdir -p "/var/log/$app"
chown -R $app:$app "/var/log/$app"

#=================================================
# ADD CONFIGURATION
#=================================================
ynh_script_progression "Adding configuration..."

# Create .env file directly (no build step needed)
ynh_config_add --template=".env" --destination="$install_dir/.env"

# Create Meilisearch env file with secrets
ynh_config_add --template="meilisearch.env" --destination="$install_dir/.meilisearch.env"

#=================================================
# SETUP PERMISSIONS
#=================================================
chown -R $app:www-data "$install_dir"
chown -R $app:www-data "$data_dir"
chmod -R 750 "$install_dir"
chmod +x "$install_dir/bin/bonfire"

#=================================================
# SETUP SYSTEMD
#=================================================
ynh_script_progression "Configuring systemd services..."

# Use logrotate to manage application logfile(s)
ynh_config_add_logrotate

# Create Meilisearch systemd service
ynh_config_add_systemd --service="meilisearch-$app" --template="meilisearch.service"

# Install startup wrapper script
ynh_config_add --template="bonfire-start.sh" --destination="$install_dir/bonfire-start.sh"
chmod +x "$install_dir/bonfire-start.sh"
chown $app:$app "$install_dir/bonfire-start.sh"

# Create Bonfire systemd config
ynh_config_add_systemd

yunohost service add "meilisearch-$app" --description="Meilisearch for Bonfire" --log="/var/log/$app/meilisearch.log"
yunohost service add $app --description="Bonfire daemon" --log="/var/log/$app/$app.log"

#=================================================
# SETUP FAIL2BAN
#=================================================
ynh_script_progression "Configuring Fail2Ban..."

# Configure Fail2Ban
# Note: Bonfire logs format may vary - this is a basic pattern
# TODO: Verify actual Bonfire auth failure log format and adjust regex accordingly
ynh_config_add_fail2ban --logpath="/var/log/$app/$app.log" --failregex="^.*authentication.*failed.*<HOST>.*$"

#=================================================
# START SERVICES
#=================================================
ynh_script_progression "Starting Meilisearch service..."

ynh_systemctl --service="meilisearch-$app" --action="start" --log_path="/var/log/$app/meilisearch.log"

# Wait for Meilisearch to be ready
ynh_script_progression "Waiting for Meilisearch to be ready..."
for i in {1..30}; do
    if curl -s "http://localhost:7700/health" | grep -q "available"; then
        ynh_print_info "Meilisearch is ready"
        break
    fi
    sleep 1
done

#=================================================
# RUN DATABASE MIGRATIONS
#=================================================
ynh_script_progression "Running database migrations..."

# Run migrations using the Bonfire release command with all required env vars
cd "$install_dir"
ynh_exec_as_app HOME=$install_dir \
    MIX_ENV=prod \
    FLAVOUR=social \
    DATABASE_URL="postgresql://$app:$db_pwd@localhost/$app" \
    POSTGRES_USER="$app" \
    POSTGRES_PASSWORD="$db_pwd" \
    POSTGRES_HOST="localhost" \
    POSTGRES_DB="$db_name" \
    SECRET_KEY_BASE="$secret_key_base" \
    SIGNING_SALT="$signing_salt" \
    ENCRYPTION_SALT="$encryption_salt" \
    MEILI_MASTER_KEY="$meili_master_key" \
    DB_MIGRATE_INDEXES_CONCURRENTLY=false \
    $install_dir/bin/bonfire mix ecto.create
    $install_dir/bin/bonfire eval 'Bonfire.Common.Repo.migrate' 2>/dev/null || {
    ynh_print_info "Migration will be run on service start"
}

# Give some time after migrations and clean up any leftover processes
sleep 5

ynh_script_progression "Cleaning up any leftover Erlang processes..."
# Kill any leftover Erlang processes from previous attempts
pkill -u $app -f beam.smp 2>/dev/null || true
pkill -u $app epmd 2>/dev/null || true
pkill -u $app erl_child_setup 2>/dev/null || true
sleep 2

ynh_script_progression "Starting Bonfire daemon service..."
# Reset any failed state from previous attempts
systemctl reset-failed $app 2>/dev/null || true
# Start the service with a longer timeout
ynh_systemctl --service=$app --action="start" --log_path="/var/log/$app/$app.log" --timeout=30 || true

# Monitor service startup and wait for port to be listening
ynh_script_progression "Waiting for Bonfire to start up and bind to port $port..."

startup_success=false
for i in {1..20}; do
    sleep 5

    # Check if service is active
    if ! systemctl is-active --quiet $app; then
        if [ $i -gt 1 ]; then
            ynh_print_info "Bonfire service not running (attempt $i/20), checking logs..."
            # Show last few lines of journal to understand the issue
            journalctl -u $app -n 10 --no-pager | tail -5 || true
        fi

        # Reset failed state before attempting restart
        systemctl reset-failed $app 2>/dev/null || true
        systemctl restart $app 2>/dev/null || true
        sleep 5
        continue
    fi

    # Check if port is listening
    if netstat -tulpn 2>/dev/null | grep -q ":$port "; then
        ynh_print_info "Bonfire is successfully listening on port $port!"
        startup_success=true
        break
    else
        ynh_print_info "Bonfire running but not yet listening on port $port (attempt $i/20)..."
    fi
done

if [ "$startup_success" = false ]; then
    ynh_print_warn "Bonfire service failed to bind to port $port after 60 seconds"
    ynh_print_warn "Last 30 lines of journalctl:"
    journalctl -u $app -n 30 --no-pager || true
    ynh_print_warn "Installation continuing, but service may need manual intervention"
fi

#=================================================
# SETUP NGINX CONFIGURATION
#=================================================
ynh_script_progression "Configuring NGINX web server..."

ynh_config_add_nginx

#=================================================
# END OF SCRIPT
#=================================================

# Display post-install instructions
ynh_script_progression "Installation of $app completed. Visit https://$domain/ to create your admin account (first user becomes admin)"
